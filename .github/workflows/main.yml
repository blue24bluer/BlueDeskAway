name: VNC Desktop with Cloudflared Tunnel

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: 1. Install Desktop & VNC Server
      run: |
        sudo apt-get update -y
        sudo apt-get install -y xfce4 xfce4-goodies tightvncserver wget curl git
        mkdir -p ~/.vnc
        echo "mysecurepass" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        cat <<EOF > ~/.vnc/xstartup
        #!/bin/bash
        startxfce4 &
        EOF
        chmod +x ~/.vnc/xstartup
        vncserver -geometry 1280x800 -depth 24 :1
        echo "âœ… VNC server started on port 5901"

    - name: 2. Setup and Run noVNC (Single Block Fix)
      run: |
        # All commands are now in ONE block to maintain the working directory
        echo "--- Cloning noVNC repository ---"
        git clone https://github.com/novnc/noVNC.git
        
        # Change directory into the cloned folder
        cd noVNC
        
        echo "--- Current directory: $(pwd) ---"
        
        echo "--- Checking out stable tag v1.4.0 ---"
        git checkout v1.4.0
        
        echo "--- Initializing Submodules ---"
        git submodule update --init --recursive
        
        echo "--- Verifying that launch.sh exists in utils ---"
        if [ -f "utils/launch.sh" ]; then
          echo "âœ… Found launch.sh"
        else
          echo "âŒ ERROR: launch.sh not found after submodule update!"
          exit 1
        fi
        
        echo "--- Starting noVNC server ---"
        # Since we are inside the 'noVNC' directory, we use a relative path
        ./utils/launch.sh --vnc localhost:5901 --listen 6080 > ../novnc.log 2>&1 &
        
        # Go back to the parent directory for the next steps
        cd ..

        echo "--- Waiting for noVNC service to start ---"
        sleep 10
        
        echo "---- Displaying noVNC Log ----"
        cat novnc.log
        
        echo "--- Checking if noVNC is reachable ---"
        curl -I --fail http://localhost:6080 || (echo "âŒ Final check failed: noVNC is not responding." && exit 1)
        echo "âœ… Success! noVNC is up and running."

    - name: 3. Start Cloudflared Tunnel
      run: |
        wget -q -O cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared
        
        nohup ./cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        
        sleep 15
        
        echo "ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨:"
        grep -o 'https://[a-zA-Z0-9-]*\.trycloudflare.com' tunnel.log

    - name: 4. Keep session alive
      run: |
        echo "â³ Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†..."
        sleep 21300
