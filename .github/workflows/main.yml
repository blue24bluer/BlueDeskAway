name: VNC Desktop with Cloudflared Tunnel and Logs

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Install Desktop & VNC
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver wget curl git unzip
        mkdir -p ~/.vnc
        echo "mysecurepass" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        echo '#!/bin/bash
        startxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        vncserver :1
        netstat -tulpn | grep 5901

    - name: Setup noVNC and websockify on port 6080 with logs
      run: |
        git clone https://github.com/novnc/noVNC.git
        git clone https://github.com/novnc/websockify noVNC/utils/websockify
        nohup noVNC/utils/launch.sh --vnc localhost:5901 > novnc.log 2>&1 &
        sleep 20
        echo "---- noVNC Log Start ----"
        cat novnc.log
        echo "---- noVNC Log End ----"
        curl -I http://localhost:6080 || echo "noVNC not reachable"

    - name: Install cloudflared and start tunnel
      run: |
        wget -O cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared
        nohup ./cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        sleep 10
        echo "ğŸŒ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØµÙˆÙ„:"
        grep trycloudflare.com tunnel.log || echo "Ø±Ø§Ø¨Ø· Ù„Ù… ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯"

    - name: Keep alive
      run: sleep 300m
