name: VNC Desktop with Cloudflared Tunnel

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 hours

    steps:
    - name: 1. Install Desktop & VNC Server
      run: |
        sudo apt-get update -y
        sudo apt-get install -y xfce4 xfce4-goodies tightvncserver wget curl git
        
        mkdir -p ~/.vnc
        echo "mysecurepass" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        
        cat <<EOF > ~/.vnc/xstartup
        #!/bin/bash
        startxfce4 &
        EOF
        chmod +x ~/.vnc/xstartup
        
        vncserver -geometry 1280x720 -depth 24 :1
        echo "VNC server started on port 5901"

    - name: 2. Setup noVNC (The New Fix)
      run: |
        # --- THE NEW FIX: Correct way to clone a specific tag ---
        # 1. Clone the repository first
        git clone https://github.com/novnc/noVNC.git
        # 2. Enter the directory
        cd noVNC
        # 3. Checkout the specific stable tag
        git checkout v1.4.0
        # 4. Navigate back to the parent directory
        cd ..
        
        # Now the launch script will exist at ./noVNC/utils/launch.sh
        nohup ./noVNC/utils/launch.sh --vnc localhost:5901 --listen 6080 > novnc.log 2>&1 &
        
        sleep 10
        
        echo "---- noVNC Log Start ----"
        cat novnc.log || echo "novnc.log not found."
        echo "---- noVNC Log End ----"
        
        echo "Checking if noVNC service is running on port 6080..."
        curl -I --fail http://localhost:6080 || (echo "โ ูุดู ุชุดุบูู noVNC! The service is not responding on port 6080." && exit 1)
        echo "โ noVNC is running successfully."


    - name: 3. Start Cloudflared Tunnel
      run: |
        wget -q -O cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared
        
        nohup ./cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        
        echo "Waiting for Cloudflare Tunnel to generate the link..."
        sleep 15
        
        echo "๐ ุฑุงุจุท ุงููุตูู ูุณุทุญ ุงูููุชุจ (ุงุณุชุฎุฏู ูุฐุง ุงูุฑุงุจุท):"
        grep -o 'https://[a-zA-Z0-9-]*\.trycloudflare.com' tunnel.log || echo "ูู ูุชููู ูู ุฅูุฌุงุฏ ุงูุฑุงุจุท. ุชุญูู ูู 'tunnel.log' ูู Artifacts."

    - name: 4. Keep alive
      run: |
        echo "โณ ุงูุฎุงุฏู ูุนูู ุงูุขู. ุณูุจูู ูุดุทูุง ุญุชู ุงูุชูุงุก ุงูููุช ุงููุฎุตุต (ุฃู ุฅููุงูู ูุฏูููุง)."
        sleep 21300 # Approximately 5 hours and 55 minutes
